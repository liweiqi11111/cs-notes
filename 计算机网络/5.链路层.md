# 链路层：链路、接入网和局域网



## 概述

链路层提供的服务：

- 网络层数据报$$\rightarrow$$链路层帧

- 链路接入

  **媒体访问控制（MAC）**协议——规定帧在链路上的传输规则

  - 点对点链路：闲时发送
  - 多结点共享单个广播链路（多路访问问题）

- 可靠交付

- 差错检测和纠正



实现：

- 路由器：线路卡
- 主机：**网络适配器**/**网络接口卡(NIC)**





## 差错检测和纠正技术

- 奇偶校验 

  **二维奇偶校验**

  **前向纠错**：接收方来检测和纠正差错

- 检验和方法

  和CRC相比相对较弱

- **循环冗余检测**

  CRC编码（多项式编码）

  原理：

  1. 发送方和接收方首先协商一个r+1比特模式G（称为generator，具有国际标准）

  2. 数据段D + r个附加比特R ---> d+r比特模式

     这个附加比特R要使d+r比特模式能被G整除（除的过程中减法不借位）

  3. 接收方用G去除接收到的d+r比特。如果余数为非零，则出现了差错；否则认为数据正确而被接收

  - 如何计算附加比特R？

    1. $$
       D \cdot 2^r\oplus R= nG
       $$

    2. $$
       D \cdot 2^r = nG \oplus R
       $$
    
    3. $$
       R = remainder \frac{D\cdot 2^r}{G}
       $$





## 多路访问链路和协议

多路访问问题：如何协调多个发送和接收结点对一个共享广播信道的访问。

解决：多路访问协议——规范，进行协调，避免**碰撞**而消耗带宽



- 信道划分协议

  - 时分多路复用（TDM）——为结点分配时隙
  - 频分多路复用（FDM）——为结点分配频率
  - 码分多址（CDMA）——为结点分配一种不同的编码

- 随机接入协议

  1. 时隙ALOHA

     假设：

     - 所有帧由L比特组成
     - 时间被划分为长度为L/R秒的时隙
     - 结点只在时隙起点开始传输帧
     - 结点是同步的，以在每个时隙开始时开始传输

     发生碰撞后，以概率p重传

     N个结点中任意一个结点成功传送的概率为Np(1-p)^N-1^

     最大**效率**为1/e = 0.37

  2. ALOHA

     非时隙、完全分散的协议

     N个结点中任意一个结点成功传送的概率为p(1-p)^2(N-1)^

     最大效率：1/(2e)

  3. 载波侦听多路访问（CSMA）

     - 载波侦听——一个结点在传输前先听信道
     - 碰撞检测——当一个传输结点在传输时一直在侦听此信道

     有了载波侦听为什么还会发生碰撞——**信道传播时延**

  4. **具有碰撞检测的载波侦听多路访问（CSMA/CD）**

     检测到碰撞后，适配器终止传输，等待一个随机时间量：

     碰撞的两个结点等待时间量的间隔的设置：

     - 当碰撞结点数量较少时，时间间隔较短
     - 当碰撞结点数量较大时，时间间隔较长

     解决：**二进制指数后退算法**

     效率：
     $$
     \frac{1}{1+5d_{prop}d_{trans}}
     $$

- 轮流协议

  - 轮询协议

    指定一个主结点，主结点以循环的方式轮询每个结点

  - 令牌传递协议

    一个称为令牌的小的特殊帧在结点之间以某种固定的次序进行交换

- DOCSIS：用于电缆因特网接入的链路层协议

  综合的一个实例
  
  - 下行信道：FDM
  - 上行信道：TDM + 随机接入(微时隙请求帧)



## 交换局域网

- 链路层寻址和ARP

  1. **MAC地址**

     48位

     扁平结构（和IP地址的层次结构相反）

     MAC广播地址：FF-FF-FF-FF-FF-FF

  2. **地址解析协议(ARP)**

     将IP地址转换为MAC地址

     > 区别：DNS将主机名解析为IP地址 vs ARP——DNS为在因特网中任何地方的主机解析主机名，而ARP只为在同一个子网上的主机和路由器接口解析IP地址

     实现——查询：**主机或路由器内存中的ARP表**；更新维护<自动建立>：ARP查询分组(MAC广播)和响应分组

  3. 发送数据报到子网以外

     考虑：一个由一台路由器互联两个子网所组成的简单网络

     

- 以太网

  有线局域网

  1. 以太网帧结构

     - 数据字段(46-1500字节)：承载了IP数据报
     - 目的地址（6字节）
     - 源地址（6字节）
     - 类型字段（2字节）：允许以太网复用多种网络层协议
     - CRC（4字节）：检测差错
     - 前同步码（8字节）：前7个字节都是“10101010”——使发送方和接收方时钟同步；第八个字节“10101011”的最后两个比特——警告接收方“重要的内容”到来

     无连接服务、不可靠服务

  2. 以太网技术

     首字母缩写词：速率+”BASE“+物理媒体

     发展：初始<同轴电缆总线>—基于集线器的星形拓扑—**基于交换机的星形拓扑**

     

- 链路层交换机

  - 交换机转发和过滤

    过滤：决定一个帧应该转发到某个接口还是应当将其丢弃

    转发

  - 自学习——交换机表的创建

  - 性质

    - 消除碰撞
    - 异质的链路
    - 管理

  - 交换机和路由器的比较



- 虚拟局域网

  每个部门一个交换局域网，各个部门通过一个交换机等级结构互联，这样的配置存在三个缺点：

  1. 缺乏流量隔离
  2. 交换机的无效使用
  3. 管理用户困难

  解决：支持**虚拟局域网（VLAN）**的交换机

  支持VLAN的交换机的端口由管理员划分为组，每个组构成一个VLAN。

  - 互联VLAN交换机——VLAN干线连接

    问题：一个交换机如何知道到达干线端口的帧属于某个特定的VLAN？

    解决：拓展以太网帧格式——802.1Q，增加VLAN标签



